name: Daily Article Publishing

on:
  schedule:
    # Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø³ÙŠØªØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ ÙŠÙˆÙ… Ø¨ÙØ¶Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
    - cron: '0 11 * * *'
  # Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish-articles:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¬ÙŠØª Ù‡Ø¨ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install -r requirements.txt
      
      # 1. ØªØ´ØºÙŠÙ„ Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø·ÙˆÙŠÙ„)
      - name: Run article generator
        env:
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
          GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
          GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
          BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
          BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
          IMGBB_API_KEY: ${{ secrets.IMGBB_API_KEY }}
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_PAGE_ACCESS_TOKEN: ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
          MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
          GITHUB_REPO_NAME: ${{ github.repository }}
          YOUTUBE_CREDENTIALS_JSON: ${{ secrets.YOUTUBE_CREDENTIALS_JSON }}
        run: python -u article_generator_advanced.py

      # 2. Ø®Ø·ÙˆØ© ØªØºÙŠÙŠØ± Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ (Randomizer)
      - name: Randomize Next Schedule
        run: python update_schedule.py

      # 3. Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆÙ…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
      - name: Commit Changes (KG + Schedule)
        if: always() # ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹
        run: |
          git config --global user.name 'Scheduler Bot'
          git config --global user.email 'scheduler@bot.com'
          
          # Ø³Ø­Ø¨ Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨
          git pull origin main --rebase || echo "No conflicts"
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø±ÙØ©
          git add knowledge_graph.json
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù Ø§Ù„Ù€ workflow (Ø§Ù„Ù…Ø­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¬Ø¯ÙŠØ¯)
          git add .github/workflows/daily-publish.yml
          
          if [ -d "archive" ]; then
            git add archive/
          fi
          
          # ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆÙ…ÙŠØª ÙˆØ§Ù„Ø±ÙØ¹
          git diff --staged --quiet || (git commit -m "ğŸ“… Auto-Update: Schedule & Knowledge Graph" && git push origin main)
