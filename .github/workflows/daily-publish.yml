name: Daily Article Publishing

on:
  schedule:
    # ุชูููุช ุงูุชุฑุงุถู (36 ุฏูููุฉ ุจุนุฏ 12 ุธูุฑุงู ุจุชูููุช UTC) - ููููู ุชุนุฏููู ูุงุญูุงู
    - cron: '5 12 * * *' 
  workflow_dispatch: # ูุณูุญ ุจุชุดุบูู ุงูู workflow ูุฏููุงู ูู ูุงุฌูุฉ GitHub

permissions:
  contents: write # ุฅุนุทุงุก ุตูุงุญูุงุช ุงููุชุงุจุฉ ูููุณุชูุฏุน ููุณูุงุญ ุจุงูู commits

jobs:
  publish-articles:
    runs-on: ubuntu-latest # ุชุดุบูู ุงููุธููุฉ ุนูู ุจูุฆุฉ Ubuntu ุญุฏูุซุฉ
    steps:
      - name: Checkout repository # ุฎุทูุฉ ุณุญุจ ุงููุณุชูุฏุน ูู GitHub
        uses: actions/checkout@v3
        with:
          # ุงุณุชุฎุฏุงู ุงูุชููู ุงูุดุฎุตู ุงูุฎุงุต ุจู (MY_GITHUB_TOKEN)
          # ูุฐุง ุงูุชููู ูุฌุจ ุฃู ูููู ูุฏ ุชู ุฅุนุฏุงุฏู ูู Secret ูู GitHub
          # ูุณูุญ ูุฐุง ุงูุชููู ููููุงู ุจุนูู commits ูุชุนุฏูู ูููุงุช ุงูู Workflow ููุณูุง
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          # ุถุฑูุฑู ูุนูููุงุช ุงูู Git ุงูุชู ุชุชุถูู history ูุซู --rebase
          fetch-depth: 0 
      
      - name: Set up Python # ุฅุนุฏุงุฏ ุจูุฆุฉ Python ุงููุทููุจุฉ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # ุชุญุฏูุฏ ุฅุตุฏุงุฑ Python ุงููุฑุงุฏ ุงุณุชุฎุฏุงูู
      
      - name: Install dependencies # ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ ูุนูู ุงููุดุฑูุน
        run: |
          sudo apt-get update # ุชุญุฏูุซ ููุงุฆู ุงูุญุฒู ูู ุงููุธุงู
          sudo apt-get install -y ffmpeg # ุชุซุจูุช ffmpeg (ูุทููุจ ุจูุงุณุทุฉ ููุชุจุฉ moviepy ูุฅูุดุงุก ุงูููุฏูููุงุช)
          pip install -r requirements.txt # ุชุซุจูุช ุฌููุน ููุชุจุงุช Python ุงููุญุฏุฏุฉ ูู requirements.txt
      
      # 1. ุชุดุบูู ุงููููุฏ ุงูุฑุฆูุณู ููููุงูุงุช ูุงูููุฏูููุงุช (main.py)
      - name: Run Article Generator
        env: # ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุชู ุณูุชู ุชูุฑูุฑูุง ูุณูุฑุจุช main.py (ูุชู ุฌูุจูุง ูู GitHub Secrets)
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
          GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
          GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
          BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
          BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
          IMGBB_API_KEY: ${{ secrets.IMGBB_API_KEY }}
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_PAGE_ACCESS_TOKEN: ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
          MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
          GITHUB_REPO_NAME: ${{ github.repository }} # ููุซู ุงููุณุชูุฏุน ุงูุญุงูู (ูุซุงู: ysrg2003/AI-Blogger-Automation)
          GITHUB_IMAGE_REPO: "ysrg2003/latest-ai-assets" # ุงุณู ุงููุณุชูุฏุน ุงูุฐู ุณูุชู ุฑูุน ุงูุตูุฑ ุนููู (ูููุฉ ุซุงุจุชุฉ)
          YOUTUBE_CREDENTIALS_JSON: ${{ secrets.YOUTUBE_CREDENTIALS_JSON }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }} 
          GOOGLE_INDEXING_JSON: ${{ secrets.GOOGLE_INDEXING_JSON }}
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }} # ุชููู ุงุฎุชูุงุฑู ูุชุญููู ููุงุฐุฌ ูู GitHub (ุฅุฐุง ูุงู ุงููุธุงู ูุณุชุฎุฏููุง)
          SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
          GOOGLE_SEARCH_CX: ${{ secrets.GOOGLE_SEARCH_CX }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
        run: python -u main.py # ุชุดุบูู ุณูุฑูุจุช main.py ูุน ุฅุฎุฑุงุฌ ุบูุฑ ูุฎุฒู ูุคูุชุงู (-u)

      # 2. ุชุบููุฑ ุชูููุช ุงูุชุดุบูู ุงูุนุดูุงุฆู ููู workflow ููููู ุงูุชุงูู
      # ูุชู ุชุดุบูู ูุฐู ุงูุฎุทูุฉ ุฏุงุฆูุงู (if: always()) ุญุชู ูู ูุดูุช ุงูุฎุทูุงุช ุงูุณุงุจูุฉุ ูุถูุงู ุชุญุฏูุซ ุงูุชูููุช
      - name: Randomize Schedule
        if: always()
        run: python update_schedule.py # ุชุดุบูู ุณูุฑูุจุช ุชุญุฏูุซ ุงูุชูููุช

      # 3. ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช ุงูุชู ุญุฏุซุช ูุฑูุนูุง ุฅูู ุงููุณุชูุฏุน (Git Operations)
      # ูุชู ุชุดุบูู ูุฐู ุงูุฎุทูุฉ ุฏุงุฆูุงู (if: always()) ูุถูุงู ุญูุธ ุญุงูุฉ ุงููุธุงู ุจุนุฏ ูู ุชุดุบูู
      - name: Push Changes
        if: always()
        run: |
          # ุฅุนุฏุงุฏ ูุนูููุงุช ุงููุณุชุฎุฏู ูู Git (ูุทููุจ ูุนูู commits)
          git config --global user.name 'Scheduler Bot'
          git config --global user.email 'scheduler@bot.com'
          
          # 1. ุฅุถุงูุฉ ุงููููุงุช ุงููุนุฏูุฉ ุฅูู ุงูู Staging Area (ุชุฌููุฒูุง ููู commit)
          # ุณูููู ุจุฅุถุงูุฉ ุงููููุงุช ุงูุชู ูุชู ุชุนุฏูููุง ุจูุงุณุทุฉ ุณูุฑุจุชุงุช Python ูุชุญุชูู ุนูู ุญุงูุฉ ุงููุธุงู
          
          # ููู ุงูู workflow ููุณู (ูุชู ุชุนุฏูู ุงูู cron ุจูุงุณุทุฉ update_schedule.py)ุ ูุฌุจ ุฅุถุงูุชู ุฏุงุฆูุงู
          git add .github/workflows/daily-publish.yml

          # ุฅุถุงูุฉ ุงููููุงุช ุงูุฃุฎุฑู ุฅุฐุง ูุงูุช ููุฌูุฏุฉ (ุจุงุณุชุฎุฏุงู ุงูุฃูุงูุฑ ุงูุดุฑุทูุฉ ุงููุฎุชุตุฑุฉ)
          [ -f "knowledge_graph.json" ] && git add knowledge_graph.json
          [ -f "source_reputation.json" ] && git add source_reputation.json
          [ -f "content_plan.json" ] && git add content_plan.json
          
          # ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ 'archive' ูุจู ูุญุงููุฉ ุฅุถุงูุชู
          [ -d "archive" ] && git add archive/
          
          # 2. ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช staged (ุชู ุฅุนุฏุงุฏูุง ููู commit) ุซู ุนูู Commit ููุง
          # ุงุณุชุฎุฏุงู 'git diff-index --quiet HEAD' ููุชุญูู ููุง ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช staged
          if ! git diff-index --quiet HEAD; then # <-- ุงูุชุตุญูุญ: 'then' ูุฌุจ ุฃู ุชููู ููุงุ ูุน ุนูุณ ุงูุดุฑุท ูุณูููุฉ ุงููุฑุงุกุฉ
            git commit -m "๐ Auto-Update: Schedule & Content Data" # ุนูู commit ููุชุบููุฑุงุช
            
            # 3. ุณุญุจ ุงูุชุญุฏูุซุงุช ูู ุงูุณูุฑูุฑ ูุฏูุฌูุง ูุน ุงูู commit ุงููุญูู
            # 'git pull origin main --rebase --autostash' ูุฒูุงุฏุฉ ุงููุชุงูุฉ
            git pull origin main --rebase --autostash
            
            # 4. ุงูุฑูุน ุงูููุงุฆู: ุฏูุน ุงูุชุบููุฑุงุช ุฅูู ุงููุณุชูุฏุน ุงูุจุนูุฏ
            git push origin main
          else # <-- ุงูุชุตุญูุญ: 'else' ุชุฃุชู ููุง
            echo "No changes to commit." # ูุง ุชูุฌุฏ ุชุบููุฑุงุช stagedุ ูุง ุญุงุฌุฉ ููู commit
          fi # <-- ุงูุชุตุญูุญ: 'fi' ุชุบูู ุฌููุฉ ุงูุดุฑุท
