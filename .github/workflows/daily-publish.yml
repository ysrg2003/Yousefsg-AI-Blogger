name: Daily Article Publishing

on:
  schedule:
    - cron: '36 12 * * *' # ุชูููุช ุงูุชุฑุงุถู (2 ุธูุฑุง ุจุชูููุช UTC) - ููููู ุชุนุฏููู ูุงุญูุงู
  workflow_dispatch: # ูุณูุญ ุจุชุดุบูู ุงูู workflow ูุฏููุงู ูู ูุงุฌูุฉ GitHub

permissions:
  contents: write # ุฅุนุทุงุก ุตูุงุญูุงุช ุงููุชุงุจุฉ ูููุณุชูุฏุน ููุณูุงุญ ุจุงูู commits

jobs:
  publish-articles:
    runs-on: ubuntu-latest # ุชุดุบูู ุงููุธููุฉ ุนูู ุจูุฆุฉ Ubuntu ุญุฏูุซุฉ
    steps:
      - name: Checkout repository # ุฎุทูุฉ ุณุญุจ ุงููุณุชูุฏุน
        uses: actions/checkout@v3
        with:
          # ุงุณุชุฎุฏุงู ุงูุชููู ุงูุดุฎุตู ุงูุฎุงุต ุจู ููุณูุงุญ ุจุงูููุงู ุจุงูู commits ูุชุนุฏูู ูููุงุช ุงูู Workflow
          # ูุฐุง ุงูุชููู (MY_GITHUB_TOKEN) ูุฌุจ ุฃู ูููู ูุฏ ุชู ุฅุนุฏุงุฏู ูู Secret ูู GitHub
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          # ุถุฑูุฑู ูุนูููุงุช ุงูู Git ุงููุชูุฑุฑุฉ ุงูุชู ุชุชุถูู history ูุซู --rebase
          fetch-depth: 0 
      
      - name: Set up Python # ุฅุนุฏุงุฏ ุจูุฆุฉ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # ุชุญุฏูุฏ ุฅุตุฏุงุฑ Python ุงููุฑุงุฏ ุงุณุชุฎุฏุงูู
      
      - name: Install dependencies # ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ ูู requirements.txt
        run: |
          sudo apt-get update # ุชุญุฏูุซ ููุงุฆู ุงูุญุฒู (ุถุฑูุฑู ูุจู ุชุซุจูุช ffmpeg)
          sudo apt-get install -y ffmpeg # ุชุซุจูุช ffmpeg (ูุทููุจ ูู moviepy ูู video_renderer.py)
          pip install -r requirements.txt # ุชุซุจูุช ุฌููุน ููุชุจุงุช Python ูู ุงูููู
      
      # 1. ุชุดุบูู ุงููููุฏ ุงูุฑุฆูุณู ููููุงูุงุช ูุงูููุฏูููุงุช
      - name: Run Article Generator
        env: # ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุชู ูุญุชุงุฌูุง ุงูุณูุฑูุจุชุ ูุชู ุฌูุจูุง ูู GitHub Secrets
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
          GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
          GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
          BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
          BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
          IMGBB_API_KEY: ${{ secrets.IMGBB_API_KEY }}
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_PAGE_ACCESS_TOKEN: ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
          MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
          GITHUB_REPO_NAME: ${{ github.repository }} # ููุซู ุงููุณุชูุฏุน ุงูุญุงูู (ูุซุงู: ysrg2003/AI-Blogger-Automation)
          GITHUB_IMAGE_REPO: "ysrg2003/latest-ai-assets" # ุงุณู ุงููุณุชูุฏุน ุงูุฐู ุณูุชู ุฑูุน ุงูุตูุฑ ุนููู (ุซุงุจุช ููุง)
          YOUTUBE_CREDENTIALS_JSON: ${{ secrets.YOUTUBE_CREDENTIALS_JSON }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }} 
          GOOGLE_INDEXING_JSON: ${{ secrets.GOOGLE_INDEXING_JSON }}
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }} # ุชููู ุงุฎุชูุงุฑู ูุชุญููู ููุงุฐุฌ ูู GitHub (ุฅุฐุง ูุงู ุงููุธุงู ูุณุชุฎุฏููุง)
          SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
        run: python -u main.py # ุชุดุบูู ุงูุณูุฑูุจุช ุงูุฑุฆูุณู (main.py)
        
      # 2. ุชุบููุฑ ุชูููุช ุงูุชุดุบูู ุงูุนุดูุงุฆู ููู workflow ููููู ุงูุชุงูู
      # ูุชู ุชุดุบูููุง ุฏุงุฆูุงู (if: always()) ุญุชู ูู ูุดูุช ุงูุฎุทูุงุช ุงูุณุงุจูุฉุ ูุถูุงู ุชุญุฏูุซ ุงูุชูููุช
      - name: Randomize Schedule
        if: always()
        run: python update_schedule.py # ุชุดุบูู ุณูุฑูุจุช ุชุญุฏูุซ ุงูุชูููุช

      # 3. ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช ุงูุชู ุญุฏุซุช ูุฑูุนูุง ุฅูู ุงููุณุชูุฏุน (Git Operations)
      # ูุชู ุชุดุบูููุง ุฏุงุฆูุงู (if: always()) ูุถูุงู ุญูุธ ุญุงูุฉ ุงููุธุงู
      - name: Push Changes
        if: always()
        run: |
          # ุฅุนุฏุงุฏ ูุนูููุงุช ุงููุณุชุฎุฏู ูู Git
          git config --global user.name 'Scheduler Bot'
          git config --global user.email 'scheduler@bot.com'
          
          # 1. ุฅุถุงูุฉ ุงููููุงุช ุงููุนุฏูุฉ ุฅูู ุงูู Staging Area (ุชุฌููุฒูุง ููู commit)
          # ูุฐู ุงููููุงุช ูุชู ุชุนุฏูููุง ุจูุงุณุทุฉ ุณูุฑุจุชุงุช Python ูุชุญุชูู ุนูู ุญุงูุฉ ุงููุธุงู
          git add knowledge_graph.json         # ูุงุนุฏุฉ ุจูุงูุงุช ุงูููุงูุงุช ุงูููุดูุฑุฉ (history_manager.py)
          git add .github/workflows/daily-publish.yml # ููู ุงูู workflow ููุณู (ูุชู ุชุนุฏูู ุงูู cron ุจูุงุณุทุฉ update_schedule.py)
          git add source_reputation.json       # ููู ุณูุนุฉ ุงููุตุงุฏุฑ (news_fetcher.py)
          # git add content_plan.json            # ููู ุฎุทุฉ ุงููุญุชูู (ุงูุนูุงููุฏ) (cluster_manager.py)
          
          # ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ 'archive' ูุจู ูุญุงููุฉ ุฅุถุงูุชู (ุงุฎุชูุงุฑูุ ุฅุฐุง ูุงู ุงููุธุงู ูููู ุจุงูุฃุฑุดูุฉ)
          if [ -d "archive" ]; then
            git add archive/
          fi
          
          # 2. ุงูุชุญูู ูู ูุฌูุฏ ุชุบููุฑุงุช staged (ุชู ุฅุนุฏุงุฏูุง ููู commit) ุซู ุนูู Commit ููุง
          # ุงูุฃูุฑ 'git diff-index --quiet HEAD' ูุชุญูู ููุง ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช ุชู ุนูู 'git add' ููุง
          # ููุงุฑูุฉ ุจุขุฎุฑ commit. ุฅุฐุง ูู ุชูู ููุงู ุชุบููุฑุงุชุ ูุฅู ุงูุฃูุฑ ููุฑ ุจุตูุช (true)
          # ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุชุ ูุฅูู ููุดู (false) ูููุง ูููู ุจุงูู commit
          if git diff-index --quiet HEAD; then
            echo "No changes to commit." # ูุง ุชูุฌุฏ ุชุบููุฑุงุชุ ูุง ุญุงุฌุฉ ููู commit
          else
            git commit -m "๐ Auto-Update: Schedule & Content Data" # ุนูู commit ููุชุบููุฑุงุช
            
            # 3. ุณุญุจ ุงูุชุญุฏูุซุงุช ูู ุงูุณูุฑูุฑ ูุฏูุฌูุง ูุน ุงูู commit ุงููุญูู
            # ุงุณุชุฎุฏุงู 'git pull origin main --rebase --autostash'
            #   - 'origin main': ุณุญุจ ุงูุชุญุฏูุซุงุช ูู ุงููุฑุน ุงูุฑุฆูุณู (main) ุนูู ุงูุณูุฑูุฑ ุงูุจุนูุฏ (origin)
            #   - '--rebase': ุฏูุฌ ุงูุชุบููุฑุงุช ุจุดูู ุฎุทู (ูุถุน ุงูุชุบููุฑุงุช ุงููุญููุฉ ููู ุงูุชุบููุฑุงุช ุงููุณุญูุจุฉ)
            #   - '--autostash': ูููู ุชููุงุฆูุงู ุจุชุฎุฒูู ุฃู ุชุบููุฑุงุช ูู ูุชู ุนูู 'git add' ููุง ูุคูุชุงู ูุจู ุงูู rebaseุ
            #                   ุซู ูุนูุฏ ุชุทุจูููุง ุจุนุฏ ุงูุงูุชูุงุก. ูุฐุง ูููุน ุฑุณุงูุฉ "You have unstaged changes"
            #                   ููุฒูุฏ ูู ูุชุงูุฉ ุนูููุฉ ุงูุฑูุน.
            git pull origin main --rebase --autostash
            
            # 4. ุงูุฑูุน ุงูููุงุฆู: ุฏูุน ุงูุชุบููุฑุงุช (ุงููุญููุฉ ูุงููุณุญูุจุฉ) ุฅูู ุงููุณุชูุฏุน ุงูุจุนูุฏ
            git push origin main
          fi
