name: Daily Article Publishing

on:
  schedule:
    # Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙŠÙˆÙ…ÙŠØ§Ù‹
    - cron: '54 17 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish-articles:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ Workflow
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0 # Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù€ Git Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install -r requirements.txt
      
      # 1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
      - name: Run Article Generator
        env:
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
          GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
          GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          BLOGGER_CLIENT_ID: ${{ secrets.BLOGGER_CLIENT_ID }}
          BLOGGER_CLIENT_SECRET: ${{ secrets.BLOGGER_CLIENT_SECRET }}
          BLOGGER_REFRESH_TOKEN: ${{ secrets.BLOGGER_REFRESH_TOKEN }}
          IMGBB_API_KEY: ${{ secrets.IMGBB_API_KEY }}
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_PAGE_ACCESS_TOKEN: ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
          MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
          GITHUB_REPO_NAME: ${{ github.repository }}
          GITHUB_IMAGE_REPO: "ysrg2003/latest-ai-assets" 
          YOUTUBE_CREDENTIALS_JSON: ${{ secrets.YOUTUBE_CREDENTIALS_JSON }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }} 
        run: python -u article_generator_advanced.py

      # 2. ØªØºÙŠÙŠØ± Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù„Ù„ØºØ¯
      - name: Randomize Schedule
        if: always()
        run: python update_schedule.py

      # 3. Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ±ÙØ¹Ù‡Ø§ (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
      - name: Push Changes
        if: always()
        run: |
          git config --global user.name 'Scheduler Bot'
          git config --global user.email 'scheduler@bot.com'
          
          # 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù€ Staging Area
          git add knowledge_graph.json
          git add .github/workflows/daily-publish.yml
          
          if [ -d "archive" ]; then
            git add archive/
          fi
          
          # 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª Ø«Ù… Ø¹Ù…Ù„ Commit
          # Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ÙƒÙˆÙ…ÙŠØª "Ù‚Ø¨Ù„" Ø§Ù„Ù€ Pull Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø© Unstaged changes
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“… Auto-Update: Schedule & Content Data"
            
            # 3. Ø³Ø­Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ¯Ù…Ø¬Ù‡Ø§ Ù…Ø¹ Ø§Ù„ÙƒÙˆÙ…ÙŠØª Ø§Ù„Ù…Ø­Ù„ÙŠ
            git pull origin main --rebase
            
            # 4. Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            git push origin main
          fi
